服务器主循环为每一个连接创建一个定时器，并对每个连接进行定时。另外，利用升序时间链表容器将所有定时器串联起来，若主循环接收到定时通知，则在链表中依次执行定时任务。

定时器处理非活动连接模块，主要分为两部分，其一为定时方法与信号通知流程，其二为定时器及其容器设计、定时任务的处理。

# 定时方法与信号通知流程
通过addsig注册SIGALARM信号函数，当信号到达后回调sig_handler函数，此函数将信号写入管道中，然后主循环从管道读出信号，进行逻辑处理（删除不活跃对象）

## 信号处理流程
- Linux下的信号采用异步处理机制，信号处理函数和当前的进程时两条不同的执行路线。具体的，当进程收到信号时，操作系统会中断进程当前的正常流程，转而进入信号处理函数执行操作，完成后再返回中断的地方继续执行。
- 为避免信号竞态现象发生，信号处理期间系统不会再次触发它。所以，为确保该信号不被屏蔽太久，信号处理函数需要尽可能快地执行完毕。
- 一般的信号处理函数需要处理该信号对应的逻辑，当该逻辑比较复杂时，信号处理函数执行时间过长，会导致信号屏蔽太久。这里的解决方案是，信号处理函数仅仅发送信号通知程序主循环，将信号对应的处理逻辑放在程序主循环中，由主循环执行信号对应的逻辑代码。

## 统一事件源
统一事件源，是指将信号事件与其他事件一样被处理。
具体的，信号处理函数使用管道将信号传递给主循环，信号处理函数往管道的写端写入信号值，主循环则从管道的读端读出信号值，使用I/O复用系统调用来监听管道读端的可读事件，这样信号事件与其他文件描述符都可以通过epoll来监测，从而实现统一处理。

## 信号处理机制

## 代码逻辑

### 信号通知逻辑
- 创建管道 其中管道写端写入信号值 管道读端通过I/O复用系统检测读事件
- 设置信号处理函数SIGALARM(时间到了出发)和SIGTERM(kill会出发，Ctrl+c)
  - 通过sigaction结构体和sigaction函数注册信号捕捉函数
  - 在结构体的handler参数设置信号处理函数，具体的从管道写端写入信号
- 利用I/O复用系统检测管道读端文件描述符的可读事件
- 信息值传递给主循环，主循环再根据接收到的信号执行目标信号对应的逻辑代码

# 定时器
- 定时事件 
  是指固定一段时间之后触发某段代码，由该段代码处理一个事件，如从内核事件表删除事件，并关闭文件描述符，释放连接资源。
- 定时器 
  是指利用结构体或其他形式，将多种定时事件进行封装起来。具体的，这里只涉及一种定时事件，即定期检测非活跃连接，这里将该**定时事件与连接资源**封装为一个结构体定时器
- 定时器容器
  是指使用某种容器类数据结构，将上述多个定时器组合起来，便于对定时事件统一管理。具体的，项目中使用升序链表将所有定时器串联组织起来

## 定时器设计
将连接资源和定时事件等封装起来，具体包括连接资源、超时时间和回调函数，这里的回调函数指向定时事件。
- 连接资源 客户端套接字地址，文件描述符，定时器
- 定时事件 为回调函数，将其封装起来由用户自定义，这里是删除非活动socket上的注册事件，并关闭
- 定时器超时时间 = 浏览器和服务器连接时刻+固定时间(TIMESLOT),可以看出定时器使用绝对是按作为超时值，这里alarm设置为5秒，连接超时为15秒。

## 定时器容器设计

项目中的定时器容器为带头尾节点的双向链表，具体的为每个连接创建一个定时器，将其添加到链表中，并按照**超时时间升序**排列，执行定时任务，将到期的定时器从链表删除 
主要涉及双向链表的插入，删除操作，其中添加定时器的事件复杂度是O(n),删除定时器的事件复杂度是O(1)。

### 升序双向链表主要逻辑
- 创建头尾节点(虚结点)
- add_timer函数 将目标定时器添加到链表中 按升序添加
  - 只有头尾 直接插入
  - 否则升序插入
- adjust_timer函数 当定时任务发生变化时 调整对应定时器在链表中的位置
  - 客户端在设定时间内有数据收发 则当前时刻对该时刻定时器重新设定时间 这里只是往后延长超时时间
  - 被调整的目标定时器在尾部，或定时器新的超时值仍然小于下一个定时器的超时 不用调整
  - 否则将定时器链表取出，重新插入链表
- del_timer函数将超时的定时器从链表删除
  - 常规的链表删除
### 定时任务处理函数
使用统一事件源，SIGALRM信号每次被触发，主循环中调用一次定时任务处理函数，处理链表容器中到期的定时器
具体的遍历定时器升序链表容器，从头结点开始依次处理每个定时器
- 如果当前时间小于定时器的超时时间 后面的定时器也没有到期 跳出
- 若当前时间大于定时器超时时间，即找到了到期的定时器，执行回调函数，然后将它从链表中删除，然后继续遍历

### 如何使用定时器
服务器首先创建定时器容器链表，然后用统一事件源将异常事件，读写事件和信号事件统一处理，根据不同事件的对应逻辑使用定时器。
- 浏览器与服务器连接时，创建该连接对应的定时器，并将该定时器添加到链表上
- 处理异常事件时，执行定时事件，服务器关闭连接，从链表上移除对应定时器
- 处理定时信号时，将定时标志设置为true
- 处理读事件时，若某连接上发生读事件，将对应定时器向后移动，否则，执行定时事件
- 处理写事件时，若服务器通过某连接给浏览器发送数据，将对应定时器向后移动，否则，执行定时事件
